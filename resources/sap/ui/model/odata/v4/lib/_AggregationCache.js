/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_ConcatHelper","./_GroupLock","./_Helper","./_MinMaxHelper","./_TreeState","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/odata/ODataUtils"],function(e,t,n,i,o,r,s,a,l,d){"use strict";function u(e,n,i,r,a){t.call(this,e,n,r,true);this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.iResetCount=0;this.bUnifiedCache=i.expandTo>=Number.MAX_SAFE_INTEGER||!!i.createInPlace;this.doReset(i,a);this.addKeptElement=this.oFirstLevel.addKeptElement;this.removeKeptElement=this.oFirstLevel.removeKeptElement;this.requestSideEffects=this.oFirstLevel.requestSideEffects;this.oTreeState=new s(i.$NodeProperty,e=>o.getKeyFilter(e,this.sMetaPath,this.getTypes()))}u.prototype=Object.create(t.prototype);u.prototype.addTransientCollection=null;u.prototype._delete=function(e,n,i,r,s){let a=parseInt(i);if(isNaN(a)){throw new Error(`Unsupported kept-alive entity: ${this.sResourcePath}${i}`)}const d=this.aElements[a];const u=o.getPrivateAnnotation(d,"predicate");if(d["@$ui5.node.isExpanded"]){throw new Error(`Unsupported expanded node: ${this.sResourcePath}${u}`)}const h=o.getPrivateAnnotation(d,"parent");if(d["@$ui5.context.isTransient"]){return h._delete(e,n,o.getPrivateAnnotation(d,"transientPredicate"))}if(this.oCountPromise){this.createCountPromise()}return l.all([this.oRequestor.request("DELETE",n,e,{"If-Match":d}),this.readCount(e)]).then(()=>{this.oTreeState.delete(d);if(this.aElements.$count===undefined){return}a=t.getElementIndex(this.aElements,u,a);const e=h.removeElement(o.getPrivateAnnotation(d,"rank",0),u);const n=o.getPrivateAnnotation(d,"descendants",0);for(let t=0;t<n;t+=1){h.removeElement(e)}const i=n+1;if(h===this.oFirstLevel){this.adjustDescendantCount(d,a,-i)}else if(!h.getValue("$count")){this.makeLeaf(this.aElements[a-1])}this.shiftRank(a,-i);this.removeElement(a,u);s(a,-1)})};u.prototype.addElements=function(t,n,i,r){var s=this.aElements,a=this.oAggregation.$NodeProperty,d=this;function u(t,u){var h=s[n+u],c,f=o.getPrivateAnnotation(t,"predicate"),g=o.getPrivateAnnotation(t,"transientPredicate");if(h){if(h===t){return}e.beforeOverwritePlaceholder(h,t,i,r===undefined?undefined:r+u,a)}else if(n+u>=s.length){throw new Error("Array index out of bounds: "+(n+u))}c=s.$byPredicate[f];if(c&&c!==t&&!(c instanceof l)){if(s.includes(c)){const e=i.fixDuplicatePredicate(t,f);if(e){f=e;c=t}else{throw new Error("Duplicate key predicate: "+f)}}if(!c["@odata.etag"]||t["@odata.etag"]===c["@odata.etag"]){o.updateNonExisting(t,c)}else if(d.hasPendingChangesForPath(f)){throw new Error("Modified on client and on server: "+d.sResourcePath+f)}else{o.copySelected(c,t)}}if(f){s.$byPredicate[f]=t}if(g){s.$byPredicate[g]=t}s[n+u]=t;if(i){o.setPrivateAnnotation(t,"parent",i)}if(g){r-=1}else{o.setPrivateAnnotation(t,"rank",r+u)}}if(n<0){throw new Error("Illegal offset: "+n)}if(Array.isArray(t)){t.forEach(u)}else{u(t,0)}};u.prototype.adjustDescendantCount=function(e,t,n){let i=e["@$ui5.node.level"];let r=false;for(let e=t-1;e>=0&&i>1;e-=1){const s=this.aElements[e];const a=s["@$ui5.node.level"];if(a===0){r=true}else if(a<i){if(!r||this.isAncestorOf(e,t)){const i=o.getPrivateAnnotation(s,"descendants",0)+n;o.setPrivateAnnotation(s,"descendants",i);if(i===0){this.makeLeaf(s)}else if(i===n){o.updateAll(this.mChangeListeners,o.getPrivateAnnotation(s,"predicate"),s,{"@$ui5.node.isExpanded":true})}t=e;r=false}i=a}}};u.prototype.beforeRequestSideEffects=function(e){if(!this.oAggregation.hierarchyQualifier){throw new Error("Missing recursive hierarchy")}delete e.$apply;if(!e.$select.includes(this.oAggregation.$NodeProperty)){e.$select.push(this.oAggregation.$NodeProperty)}};u.prototype.beforeUpdateSelected=function(t,n){e.checkNodeProperty(this.aElements.$byPredicate[t],n,this.oAggregation.$NodeProperty,true)};u.prototype.collapse=function(t,n,i,r,s){const a=this.getValue(t);const l=e.getCollapsedObject(a);o.updateAll(r?{}:this.mChangeListeners,t,a,l);const d=!!i;this.oTreeState.collapse(a,d,s);const u=this.aElements;const h=u.indexOf(a);let c=this.countDescendants(a,h);if(this.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(l).length>1){c+=1}let f=c;for(let e=h+1;e<h+1+f;e+=1){const t=u[e];if(o.hasPrivateAnnotation(t,"placeholder")){continue}const s=o.getPrivateAnnotation(t,"predicate");if(d&&t["@$ui5.node.isExpanded"]){f-=this.collapse(s,n,i,r,true)}if(!n?.[s]){delete u.$byPredicate[s];delete u.$byPredicate[o.getPrivateAnnotation(t,"transientPredicate")]}}const g=u.splice(h+1,f);const p=a["@$ui5.node.level"];if(!d||!this.bUnifiedCache&&p>=this.oAggregation.expandTo){g.$level=p;g.$rank=o.getPrivateAnnotation(a,"rank");o.setPrivateAnnotation(a,"spliced",g)}u.$count-=f;if(d&&!s){this.validateAndDeleteExpandInfo(i,a)}return c};u.prototype.countDescendants=function(e,t){var n;const i=e["@$ui5.node.level"];const r=this.bUnifiedCache?Infinity:this.oAggregation.expandTo;let s=o.getPrivateAnnotation(e,"descendants");for(n=t+1;n<this.aElements.length;n+=1){const e=this.aElements[n];const t=e["@$ui5.node.level"];const a=t===0&&o.hasPrivateAnnotation(e,"placeholder");if(!a&&t<=i){break}if(t<=r&&o.hasPrivateAnnotation(e,"rank")){if(!s){break}s-=1;if(e["@$ui5.node.isExpanded"]===false){s-=o.getPrivateAnnotation(e,"descendants",0)}}}return n-(t+1)};u.prototype.create=function(e,t,n,i,r,s,a,l){if(s){throw new Error("Unsupported bAtEndOfCreated")}const d=r["@$ui5.node.parent"];delete r["@$ui5.node.parent"];const u=d?.slice(d.indexOf("("));const h=this.aElements;const c=h.$byPredicate[u];if(c?.["@$ui5.node.isExpanded"]===false){throw new Error("Unsupported collapsed parent: "+d)}const f=c?c["@$ui5.node.level"]+1:1;let g=f>this.oAggregation.expandTo&&!this.oAggregation.createInPlace?o.getPrivateAnnotation(c,"cache"):this.oFirstLevel;if(!g){g=this.createGroupLevelCache(c);g.setEmpty();o.setPrivateAnnotation(c,"cache",g)}o.addByPath(this.mPostRequests,i,r);const p=h.indexOf(c)+1;if(this.oCountPromise){const t=l;this.createCountPromise(true);l=()=>{this.readCount(e)?.catch(this.oRequestor.getModelInterface().getReporter());t()}}const P=g.create(e,t,n,i,r,s,a,l,()=>{o.removeByPath(this.mPostRequests,i,r);this.oCountPromise?.$restore();if(this.oAggregation.createInPlace){return}h.$count-=1;delete h.$byPredicate[i];h.splice(p,1)});if(d){o.getPrivateAnnotation(r,"postBody")[this.oAggregation.$ParentNavigationProperty+"@odata.bind"]=o.makeRelativePath("/"+d,"/"+this.sResourcePath)}const m=c&&c["@$ui5.node.isExpanded"]===undefined;const v=m&&c?.["@$ui5.node.level"]>=this.oAggregation.expandTo;if(v){this.oTreeState.expand(c)}const $=(e,t)=>{if(m){o.updateAll(this.mChangeListeners,u,c,{"@$ui5.node.isExpanded":true})}r["@$ui5.node.level"]=f;h.splice(e,0,null);this.addElements(r,e,g,t);h.$count+=1};const y=(e,t)=>{g.removeElement(0);o.deletePrivateAnnotation(r,"transientPredicate");delete h.$byPredicate[i];if(t!==undefined){this.adjustDescendantCount(r,e,+1);g.restoreElement(t,r);o.setPrivateAnnotation(r,"rank",t);this.shiftRank(e,+1)}};if(this.oAggregation.createInPlace){return P.then(async()=>{o.removeByPath(this.mPostRequests,i,r);delete r["@$ui5.context.isTransient"];const[t]=await Promise.all([this.requestRank(r,e),this.requestNodeProperty(r,e)]);if(v){o.setPrivateAnnotation(r,"rank",t)}else if(t===undefined){g.removeElement(0)}else{$(t,t);y(t,t)}return r})}$(p,undefined);return P.then(async()=>{o.removeByPath(this.mPostRequests,i,r);h.$byPredicate[o.getPrivateAnnotation(r,"predicate")]=r;r["@$ui5.node.level"]=f;this.oTreeState.setOutOfPlace(r,c);if(g===this.oFirstLevel&&this.oAggregation.expandTo>1){const[t]=await Promise.all([this.requestRank(r,e),this.requestNodeProperty(r,e,true)]);y(p,t)}else{await this.requestNodeProperty(r,e,true)}return r})};u.prototype.createCountPromise=function(e){const t=this.oCountPromise;if(t?.isPending()){return}let n;this.oCountPromise=new l(e=>{n=t=>{delete this.oCountPromise?.$old;e(t)}});this.oCountPromise.$resolve=n;this.oCountPromise.$restore=()=>{n(t)};this.oCountPromise.$old=t;this.oCountPromise.$retryIfFailed=e};u.prototype.createGroupLevelCache=function(n,i){var r=this.oAggregation,s=n?n["@$ui5.node.level"]+1:1,a,l,d,h,c,f,g;if(r.hierarchyQualifier){f=Object.assign({},this.mQueryOptions)}else{a=e.getAllProperties(r);h=s>r.groupLevels.length;d=h?r.groupLevels.concat(Object.keys(r.group).sort()):r.groupLevels.slice(0,s);f=e.filterOrderby(this.mQueryOptions,r,s);g=!h&&Object.keys(r.aggregate).some(function(e){return r.aggregate[e].subtotals})}if(n){c=o.getPrivateAnnotation(n,"filter")||o.getKeyFilter(n,this.sMetaPath,this.getTypes());f.$$filterBeforeAggregate=c+(f.$$filterBeforeAggregate?" and ("+f.$$filterBeforeAggregate+")":"")}if(!i){delete f.$count;f=e.buildApply(r,f,s)}f.$count=true;l=t.create(this.oRequestor,this.sResourcePath,f,true);l.calculateKeyPredicate=r.hierarchyQualifier?u.calculateKeyPredicateRH.bind(null,n,r):u.calculateKeyPredicate.bind(null,n,d,a,h,g);if(c){l.$parentFilter=c}if(!r.hierarchyQualifier){l.fixDuplicatePredicate=u.fixDuplicatePredicate.bind(l)}return l};u.prototype.doReset=function(t,i){this.oAggregation=t;this.sToString=this.getDownloadUrl("");const o=[];if(this.mQueryOptions.$count){if(t.hierarchyQualifier){this.createCountPromise()}else if(t.groupLevels.length){this.setQueryOptions({...this.mQueryOptions,$$leaves:true});this.oCountPromise=new l(function(e){o.push(t=>{e(parseInt(t.UI5__leaves))})})}else{this.oCountPromise=undefined}}else{this.oCountPromise=undefined}this.oGrandTotalPromise=i?new l(n=>{o.push(i=>{e.handleGrandTotal(t,i);n(i)})}):undefined;const r=o.length>0;this.oFirstLevel=this.createGroupLevelCache(null,r);if(r){o.push(function(){});n.enhanceCache(this.oFirstLevel,t,o)}};u.prototype.expand=function(t,n,r,s,a){var d,u=typeof n==="string"?this.getValue(n):n,h=o.getPrivateAnnotation(u,"spliced"),c=this;if(n!==u){o.updateAll(this.mChangeListeners,n,u,e.getOrCreateExpandedObject(this.oAggregation,u));this.oTreeState.expand(u,r)}if(r>=Number.MAX_SAFE_INTEGER){return l.resolve(this.validateAndDeleteExpandInfo(t,u)).then(()=>-1)}if(h){o.deletePrivateAnnotation(u,"spliced");const e=this.aElements;const t=e.indexOf(u)+1;this.aElements=e.concat(h,e.splice(t));this.aElements.$byPredicate=e.$byPredicate;d=h.length;this.aElements.$count=e.$count+d;o.copySelected(e,this.aElements);const n=u["@$ui5.node.level"]-h.$level;const r=o.getPrivateAnnotation(u,"rank")-h.$rank;h.forEach(function(e){var t=o.getPrivateAnnotation(e,"predicate");if(e["@$ui5.node.level"]){e["@$ui5.node.level"]+=n}if(o.getPrivateAnnotation(e,"parent")===c.oFirstLevel){const t=o.getPrivateAnnotation(e,"rank");if(t!==undefined){o.setPrivateAnnotation(e,"rank",t+r)}}if(!o.hasPrivateAnnotation(e,"placeholder")){if(h.$stale&&!s[t]){c.turnIntoPlaceholder(e,t)}else{c.aElements.$byPredicate[t]=e;const n=o.getPrivateAnnotation(e,"transientPredicate");if(n){c.aElements.$byPredicate[n]=e}if(o.hasPrivateAnnotation(e,"expanding")){o.deletePrivateAnnotation(e,"expanding");d+=c.expand(i.$cached,e,1,{}).getResult()}}}});return l.resolve(d)}if(this.bUnifiedCache||u["@$ui5.node.level"]<this.oAggregation.expandTo){return l.resolve(-1)}let f=o.getPrivateAnnotation(u,"cache");if(!f){f=this.createGroupLevelCache(u);o.setPrivateAnnotation(u,"cache",f)}return f.read(0,this.iReadLength,0,t,a).then(function(t){var i=c.aElements.indexOf(u)+1,r=u["@$ui5.node.level"],s=e.getCollapsedObject(u),a=c.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(s).length>1,l;if(!u["@$ui5.node.isExpanded"]){o.deletePrivateAnnotation(u,"spliced");return 0}if(!i){o.setPrivateAnnotation(u,"expanding",true);return 0}d=t.value.$count;if(o.hasPrivateAnnotation(u,"groupLevelCount")&&o.getPrivateAnnotation(u,"groupLevelCount")!==d){throw new Error("Unexpected structural change: groupLevelCount")}o.setPrivateAnnotation(u,"groupLevelCount",d);o.updateAll(c.mChangeListeners,n,u,{"@$ui5.node.groupLevelCount":d});if(a){d+=1}if(i===c.aElements.length){c.aElements.length+=d}else{for(l=c.aElements.length-1;l>=i;l-=1){c.aElements[l+d]=c.aElements[l];delete c.aElements[l]}}c.addElements(t.value,i,f,0);for(l=i+t.value.length;l<i+t.value.$count;l+=1){c.aElements[l]=e.createPlaceholder(r+1,l-i,f)}if(a){s=Object.assign({},s);e.setAnnotations(s,undefined,true,r,e.getAllProperties(c.oAggregation));o.setPrivateAnnotation(s,"predicate",o.getPrivateAnnotation(u,"predicate").slice(0,-1)+",$isTotal=true)");c.addElements(s,i+d-1)}c.aElements.$count+=d;return d},function(t){o.updateAll(c.mChangeListeners,n,u,e.getCollapsedObject(u));c.oTreeState.collapse(u);throw t})};u.prototype.fetchParentIndex=function(e,t){const n=this.aElements[e]["@$ui5.node.level"];for(let t=e-1;t>=0;t-=1){const i=this.aElements[t]["@$ui5.node.level"];if(i===0){break}if(i===n){e=t}}const i=this.aElements[e];let r=o.getPrivateAnnotation(i,"parentIndexPromise");if(r){return r}const s=o.getKeyFilter(i,this.sMetaPath,this.getTypes());const a=Object.assign({},this.mQueryOptions);a.$apply="ancestors($root"+this.oAggregation.$path+","+this.oAggregation.hierarchyQualifier+","+this.oAggregation.$NodeProperty+",filter("+s+"),1)";const d=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,a);r=this.oRequestor.request("GET",d,t).then(async e=>{const n=e.value[0];const i=this.aElements.$byPredicate[o.getKeyPredicate(n,this.sMetaPath,this.getTypes())];if(i&&o.getPrivateAnnotation(i,"rank")!==undefined){return this.aElements.indexOf(i)}o.setPrivateAnnotation(n,"parent",this.oFirstLevel);const r=[this.oAggregation.$DistanceFromRoot,this.oAggregation.$DrillState,this.oAggregation.$LimitedDescendantCount];const[s]=await Promise.all([this.requestRank(n,t),this.requestProperties(n,r,t,true),this.requestNodeProperty(n,t,false)]);this.oFirstLevel.calculateKeyPredicate(n,this.getTypes(),this.sMetaPath);const a=this.findIndex(s);if(o.hasPrivateAnnotation(this.aElements[a],"placeholder")){this.insertNode(n,s,a)}return a}).finally(()=>{o.deletePrivateAnnotation(i,"parentIndexPromise")});r=l.resolve(r);o.setPrivateAnnotation(i,"parentIndexPromise",r);return r};u.prototype.fetchValue=function(e,t,n,o){var r=this;if(t==="$count"){if(this.oCountPromise){if(this.oAggregation.hierarchyQualifier){this.registerChangeListener("./$count",o)}if(e===i.$cached&&this.oCountPromise.$old){return this.oCountPromise.$old}return this.oCountPromise}if(this.oAggregation.hierarchyQualifier||this.oAggregation.groupLevels.length){a.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return l.resolve()}return this.oFirstLevel.fetchValue(e,t,n,o)}return l.resolve(this.aElements.$byPredicate[t.split("/")[0]]).then(function(){r.registerChangeListener(t,o);return r.drillDown(r.aElements,t,e)})};u.prototype.findIndex=function(e,t=this.oFirstLevel){return this.aElements.findIndex(n=>o.getPrivateAnnotation(n,"rank")===e&&o.getPrivateAnnotation(n,"parent")===t)};u.prototype.get1stInPlaceChildIndex=function(e){let t=e+1;while(this.aElements[t]?.["@$ui5.context.isTransient"]!==undefined){t+=1}const n=this.aElements[t];if(!n){return[-1]}const i=n["@$ui5.node.level"];const r=e>=0?this.aElements[e]["@$ui5.node.level"]+1:1;const s=o.hasPrivateAnnotation(n,"placeholder");return i===r||i===0?[t,s,r]:[-1]};u.prototype.getCreatedElements=function(e){return[]};u.prototype.getDownloadQueryOptions=function(t){if(this.oAggregation.hierarchyQualifier){if("$count"in t){t=Object.assign({},t);delete t.$count}}else{t=e.filterOrderby(t,this.oAggregation)}return e.buildApply(this.oAggregation,t,0,true)};u.prototype.getElements=function(e,t,n){if(e){throw new Error("Unsupported path: "+e)}const i=this.aElements.slice(t,n).map(e=>o.hasPrivateAnnotation(e,"placeholder")?undefined:e);i.$count=this.aElements.$count;return i};u.prototype.getInsertIndex=function(e){var t;for(t=0;t<this.aElements.length;t+=1){const n=this.aElements[t];if(o.getPrivateAnnotation(n,"rank")>e&&!this.oTreeState.isOutOfPlace(o.getPrivateAnnotation(n,"predicate"))){return t}}return t};u.prototype.getParentIndex=function(e){const t=this.aElements[e]["@$ui5.node.level"];if(t<=1){return-1}let n=false;for(let i=e;i>=0;i-=1){const o=this.aElements[i];const r=o["@$ui5.node.level"];if(r===0){n=true}else if(r<t){if(r===t-1&&(!n||this.isAncestorOf(i,e))){return i}break}}};u.prototype.getSiblingIndex=function(t,n,i){const r=this.aElements[t];const s=o.getPrivateAnnotation(r,"parent");const a=s!==this.oFirstLevel||this.oAggregation.expandTo===1&&!this.oAggregation.$ExpandLevels;const l=o.getPrivateAnnotation(r,"rank");let d=l+n;if(n<0){if(!a){d=e.findPreviousSiblingIndex(s.aElements,l)}if(d<0){return-1}}else{d+=o.getPrivateAnnotation(r,"descendants",0);if(d>=s.aElements.$count||s.aElements[d]?.["@$ui5.node.level"]<r["@$ui5.node.level"]){return-1}}if(d>=0){const e=this.findIndex(d,s);if(e<0){return-1}const t=this.aElements[e];if(a&&i||!o.hasPrivateAnnotation(t,"placeholder")){if(t["@$ui5.context.isTransient"]!==undefined){return this.getSiblingIndex(e,n,i)}return e}}};u.prototype.getQueryOptions4Single=function(e){if(e!==""){throw new Error("Unsupported path: "+e)}const t=o.clone({...this.mQueryOptions,...this.mLateExpandSelect});const n=t.$select.indexOf(this.oAggregation.$NodeProperty);if(n>=0){t.$select.splice(n,1)}return t};u.prototype.getValue=function(e){var t;t=this.fetchValue(i.$cached,e);if(t.isFulfilled()){return t.getResult()}t.caught()};u.prototype.handleOutOfPlaceNodes=function([e,...t]){if(!e){return}const n=e=>o.getKeyPredicate(e,this.sMetaPath,this.getTypes());const i=e=>parseInt(o.drillDown(e,this.oAggregation.$LimitedRank));const r={};e.value.forEach(e=>{r[n(e)]=e});const s=new Set(this.oTreeState.getOutOfPlacePredicates());t.forEach(e=>{e.value.forEach(e=>{const t=n(e);s.delete(t);if(this.aElements.$byPredicate[t]){return}const a=this.oTreeState.getOutOfPlace(t).parentPredicate;const l=r[a];if(l){const e=o.drillDown(l,this.oAggregation.$DrillState);if(e==="collapsed"){return}}else if(a){return}o.merge(e,r[t]);this.oFirstLevel.calculateKeyPredicate(e,this.getTypes(),this.sMetaPath);const d=i(e);o.deleteProperty(e,this.oAggregation.$LimitedRank);this.insertNode(e,d)})});s.forEach(e=>this.oTreeState.deleteOutOfPlace(e));this.oTreeState.getOutOfPlaceGroupedByParent().forEach(e=>{const t=r[e.parentPredicate];this.moveOutOfPlaceNodes(t&&i(t),e.nodePredicates)})};u.prototype.insertNode=function(e,t,n=t){this.addElements(e,n,this.oFirstLevel,t);this.oFirstLevel.removeElement(t);this.oFirstLevel.restoreElement(t,e)};u.prototype.isAggregated=function(e){const t=this.oAggregation.$leafLevelAggregated;if(t===undefined){return false}return t||e["@$ui5.node.isExpanded"]!==undefined};u.prototype.isAncestorOf=function(e,t){if(t===e){return true}if(t<e||!this.aElements[e]["@$ui5.node.isExpanded"]||this.aElements[e]["@$ui5.node.level"]>=this.aElements[t]["@$ui5.node.level"]){return false}return t<=e+this.countDescendants(this.aElements[e],e)};u.prototype.isDeletingInOtherGroup=function(e){return false};u.prototype.isRefreshNeededAfterCreate=function(e){const t=this.aElements[e];return this.oAggregation.createInPlace&&t["@$ui5.node.isExpanded"]===undefined&&t["@$ui5.node.level"]>=this.oAggregation.expandTo};u.prototype.keepOnlyGivenElements=function(t){var n={},i=this;t.forEach(function(e){n[e]=true});return Object.values(this.aElements.$byPredicate).filter(function(t){var r=o.getPrivateAnnotation(t,"predicate");if(!r){return}if(n[r]){e.markSplicedStale(t);n[r]=false;return true}if(!(r in n)){i.turnIntoPlaceholder(t,r)}})};u.prototype.makeLeaf=function(e){o.updateAll(this.mChangeListeners,o.getPrivateAnnotation(e,"predicate"),e,{"@$ui5.node.isExpanded":undefined});delete e["@$ui5.node.isExpanded"];o.deletePrivateAnnotation(e,"descendants")};u.prototype.move=function(e,t,n,r,s,a,d,u){let h=!this.bUnifiedCache;const c=n.slice(n.indexOf("("));const f=this.aElements.$byPredicate[c];if(!u&&this.oTreeState.isOutOfPlace(c)){this.oTreeState.deleteOutOfPlace(c);delete f["@$ui5.context.isTransient"];h=true}const g=s?.slice(s.indexOf("("));const p=this.aElements.$byPredicate[g];if(this.oTreeState.isOutOfPlace(g)){this.oTreeState.deleteOutOfPlace(g,true);h=true}if(p?.["@$ui5.node.isExpanded"]===false||p?.["@$ui5.node.level"]>=this.oAggregation.expandTo&&!p["@$ui5.node.isExpanded"]){this.oTreeState.expand(p);if(!o.hasPrivateAnnotation(p,"spliced")){h=true}}let P;const m=()=>{if(a!==undefined){h=true;const t=a?.slice(a.indexOf("("));P=this.aElements.$byPredicate[t];let n=null;if(P){this.oTreeState.deleteOutOfPlace(t);const e=this.oAggregation.$fetchMetadata(o.getMetaPath("/"+r+"/"+this.oAggregation.$Actions.ChangeNextSiblingAction+"/NextSibling/")).getResult();const i=Object.keys(e).filter(e=>e[0]!=="$");n=i.reduce((e,t)=>{e[t]=P[t];return e},{})}const i=(u?"$-2":r)+"/"+this.oAggregation.$Actions.ChangeNextSiblingAction;return this.oRequestor.request("POST",i,e.getUnlockedCopy(),{"If-Match":f,Prefer:"return=minimal"},{NextSibling:n})}};let v;if(u){h=true;const t={$select:[]};o.selectKeyProperties(t,this.getTypes()[this.sMetaPath]);const i=r+"/"+this.oAggregation.$Actions.CopyAction+this.oRequestor.buildQueryString(this.sMetaPath,t,false,true);v=this.oRequestor.request("POST",i,e.getUnlockedCopy(),{"If-Match":f},{});n="$-1"}let $=l.all([this.oRequestor.request("PATCH",n,e,{"If-Match":f,Prefer:"return=minimal"},{[this.oAggregation.$ParentNavigationProperty+"@odata.bind"]:s},null,function e(){}),m(),this.requestRank(f,e,h),d&&this.requestRank(P,e,true),v]);if(h){$=$.then(([,,t,n,i])=>()=>{let r;if(u){const t=this.aElements.$byPredicate[o.getKeyPredicate(i,this.sMetaPath,this.getTypes())];if(t){r=l.resolve(this.aElements.indexOf(t))}else{r=this.requestRank(i,e,true).then(e=>this.findIndex(e))}}return[t===undefined?undefined:this.findIndex(t),d&&this.findIndex(n),r]})}else{$=$.then(([e,,n])=>{const r=f["@$ui5.node.isExpanded"]?this.collapse(c,{}):undefined;let s=1;switch(p?p["@$ui5.node.isExpanded"]:true){case false:s=this.expand(i.$cached,g,1,t).unwrap()+1;case true:break;default:o.updateAll(this.mChangeListeners,g,p,{"@$ui5.node.isExpanded":true})}const a=this.aElements.indexOf(f);const l=o.getPrivateAnnotation(f,"descendants",0)+1;this.adjustDescendantCount(f,a,-l);this.aElements.splice(a,1);const d=o.getPrivateAnnotation(f,"rank");this.shiftRankForMove(d,l,n);this.oFirstLevel.move(d,n,l);o.updateExisting(this.mChangeListeners,c,f,{"@odata.etag":e["@odata.etag"],"@$ui5.context.isTransient":undefined,"@$ui5.node.level":p?p["@$ui5.node.level"]+1:1});o.deletePrivateAnnotation(f,"rank");const u=this.getInsertIndex(n);this.aElements.splice(u,0,f);this.adjustDescendantCount(f,u,+l);o.setPrivateAnnotation(f,"rank",n);return[s,u,r]})}return{promise:$,refresh:h}};u.prototype.moveOutOfPlaceNodes=function(e,t){const n=e===undefined?-1:this.findIndex(e);t.forEach(e=>{const t=this.aElements.$byPredicate[e];if(t){this.oTreeState.stillOutOfPlace(t,e);const o=t["@$ui5.node.isExpanded"];if(o){this.collapse(e,{})}const r=this.aElements.indexOf(t);this.aElements.splice(r,1);this.aElements.splice(n+1,0,t);if(o){this.expand(i.$cached,e,1,{})}}})};u.prototype.read=function(e,t,n,i,r){var s,a=e,u=t,h,c,f=this.oGrandTotalPromise&&this.oAggregation.grandTotalAtBottomOnly!==true,g=[],p,P=this;function m(e,t){g.push(P.readGap(h,e,t,i.getUnlockedCopy(),r))}if(f&&!e&&t===1){if(n!==0){throw new Error("Unsupported prefetch length: "+n)}i.unlock();return this.oGrandTotalPromise.then(function(e){return{value:[e]}})}if(this.aElements.$count===undefined){this.iReadLength=t+n;if(f){if(a){a-=1}else{u-=1}}g.push(this.readCount(i),this.readFirst(a,u,n,i,r))}else{const r=d._getReadRange(this.aElements,e,t,n,e=>{switch(o.getPrivateAnnotation(e,"placeholder")){case true:return o.getPrivateAnnotation(e,"parent").isMissing(o.getPrivateAnnotation(e,"rank"));case 1:return!(this.aElements.$byPredicate[o.getPrivateAnnotation(e,"predicate")]instanceof l);default:return false}});const a=Math.min(r.start+r.length,this.aElements.length);for(p=r.start;p<a;p+=1){const e=this.aElements[p];s=o.hasPrivateAnnotation(e,"placeholder")?o.getPrivateAnnotation(e,"parent"):undefined;if(s!==h){if(c!==undefined){m(c,p);h=c=undefined}if(s){c=p;h=s}}else if(c!==undefined&&o.getPrivateAnnotation(e,"rank")!==o.getPrivateAnnotation(this.aElements[p-1],"rank")+1){m(c,p);c=p}}if(c!==undefined){m(c,p)}i.unlock()}return l.all(g).then(function(){var n=P.aElements.slice(e,e+t).map(function(e){return o.hasPrivateAnnotation(e,"placeholder")?undefined:e});n.$count=P.aElements.$count;return{"@$ui5.resetCount":P.iResetCount,value:n}})};u.prototype.readCount=function(e){var t,n=this.oCountPromise&&this.oCountPromise.$resolve,i;if(n){delete this.oCountPromise.$resolve;t=Object.assign({},this.mQueryOptions);delete t.$apply;delete t.$count;delete t.$expand;delete t.$orderby;if(this.oAggregation.search){t.$search=this.oAggregation.search}delete t.$select;i=this.sResourcePath+"/$count"+this.oRequestor.buildQueryString(this.sMetaPath,t);return this.oRequestor.request("GET",i,e.getUnlockedCopy()).then(e=>{n(e);o.fireChange(this.mChangeListeners,"./$count",e)}).catch(e=>{if(e.cause&&this.oCountPromise.$retryIfFailed){this.oCountPromise.$resolve=n}else{this.oCountPromise.$restore()}throw e})}};u.prototype.readFirst=function(t,n,r,s,a){var d=this;n+=r;const u=this.oTreeState.getOutOfPlaceCount();r=Math.max(r,u);if(t>r){n+=r;t-=r}else{n+=t;t=0}const h=this.iResetCount;const c=this.oFirstLevel.bSentRequest;if(c&&u){s=i.$cached}return l.all([this.oFirstLevel.read(t,n,0,s,a),...c?[]:this.requestOutOfPlaceNodes(s)]).then(function([n,...i]){if(h!==d.iResetCount){return}if(c&&u){return}var r,s,a=0,l;d.aElements.length=d.aElements.$count=n.value.$count;if(d.aElements.length&&d.oGrandTotalPromise){d.aElements.$count+=1;d.aElements.length+=1;r=d.oGrandTotalPromise.getResult();switch(d.oAggregation.grandTotalAtBottomOnly){case false:a=1;d.aElements.$count+=1;d.aElements.length+=1;d.addElements(r,0);s=o.getPrivateAnnotation(r,"copy");d.addElements(s,d.aElements.length-1);break;case true:d.addElements(r,d.aElements.length-1);break;default:a=1;d.addElements(r,0)}}d.addElements(n.value,t+a,d.oFirstLevel,t);for(l=0;l<d.aElements.$count;l+=1){d.aElements[l]??=e.createPlaceholder(d.oAggregation.expandTo>1||d.bUnifiedCache?0:1,l-a,d.oFirstLevel)}d.handleOutOfPlaceNodes(i)})};u.prototype.readGap=function(e,t,n,i,r){const s=this.aElements[t];const a=o.getPrivateAnnotation(s,"rank");if(a===undefined){if(n-t!==1){throw new Error("Not just a single created persisted")}const a=o.getPrivateAnnotation(s,"predicate");const l=e.refreshSingle(i,"",-1,a,true,false,r).then(n=>{o.inheritPathValue(this.oAggregation.$NodeProperty.split("/"),s,n,true);this.addElements(n,t,e)});this.aElements.$byPredicate[a]=l;return l}let l=e.getQueryOptions();if(l.$count){l={...l};delete l.$count;e.setQueryOptions(l,true)}const d=e.read(a,n-t,0,i,r,true).then(n=>{var i=false,o;if(s!==this.aElements[t]&&n.value[0]!==this.aElements[t]){i=true;t=this.aElements.indexOf(s);if(t<0){t=this.aElements.indexOf(n.value[0]);if(t<0){o=new Error("Collapse before read has finished");o.canceled=true;throw o}}}this.addElements(n.value,t,e,a);if(i){o=new Error("Collapse or expand before read has finished");o.canceled=true;throw o}});if(d.isPending()){for(let e=t;e<n;e+=1){const t=o.getPrivateAnnotation(this.aElements[e],"predicate");if(t){this.aElements.$byPredicate[t]=d}}}return d};u.prototype.readGrandTotal=function(t){if(!e.hasGrandTotal(this.oAggregation.aggregate)){return}if(this.oAggregation["grandTotal like 1.84"]){throw new Error('"grandTotal like 1.84" not supported')}if(this.oAggregation.$leafLevelAggregated){throw new Error("Leaves must not be aggregated")}let n={...this.mQueryOptions};delete n.$apply;delete n.$count;delete n.$orderby;n=e.buildApply(this.oAggregation,n,-1);const i=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,n,false,false,true);return this.oRequestor.request("GET",i,t.getUnlockedCopy(),undefined,undefined,undefined,undefined,undefined,undefined,undefined,{}).then(e=>{o.updateExisting(this.mChangeListeners,"()",this.aElements.$byPredicate["()"],e.value[0])})};u.prototype.refreshKeptElements=function(e,t,n,i){const o=this.oFirstLevel.refreshKeptElements;return o.call(this,e,t,n,true)};u.prototype.refreshSingle=function(e){return l.all([t.prototype.refreshSingle.apply(this,arguments),this.readGrandTotal(e)]).then(([e])=>e)};u.prototype.replaceElement=function(e,t,n,i,r,s,a){this.visitResponse(i,r,o.getMetaPath(o.buildPath(this.sMetaPath,s)),s+n,undefined,a);o.updateAll({},"",e.$byPredicate[n],i)};u.prototype.requestFilteredOrderedPredicates=async function(t,n,i){if(!i){throw new Error("Not implemented")}let r={...this.mQueryOptions};delete r.$count;delete r.$expand;delete r.$orderby;r=e.buildApply4Hierarchy(this.oAggregation,r,true);r.$select=[];const s=this.getTypes();o.selectKeyProperties(r,s[this.sMetaPath]);const a=t.map(e=>o.getKeyFilter(this.aElements.$byPredicate[e],this.sMetaPath,s));r.$top=a.length;r.$filter=a.join(" or ");const l=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,r,false,true,true);const d=await this.oRequestor.request("GET",l,n);return d.value.map(e=>{this.calculateKeyPredicate(e,s,this.sMetaPath);return o.getPrivateAnnotation(e,"predicate")})};u.prototype.requestNodeProperty=async function(e,t,n){if(o.drillDown(e,this.oAggregation.$NodeProperty)!==undefined){return}await this.requestProperties(e,[this.oAggregation.$NodeProperty],t,true,n)};u.prototype.requestOutOfPlaceNodes=function(t){const n=this.oTreeState.getOutOfPlaceGroupedByParent();if(!n.length){return[]}const i=[];const o=e=>{const n=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,e,false,true);i.push(this.oRequestor.request("GET",n,t.getUnlockedCopy()))};let r=e.getQueryOptionsForOutOfPlaceNodesRank(n,this.oAggregation,this.oFirstLevel.getQueryOptions());o(r);n.forEach(t=>{r=e.getQueryOptionsForOutOfPlaceNodesData(t,this.oAggregation,this.mQueryOptions);o(r)});return i};u.prototype.requestProperties=async function(t,n,i,r,s,a){function l(e){e={...e};delete e.$count;delete e.$expand;delete e.$select;return e}let d;if(a){const t={...this.oAggregation,$ExpandLevels:this.oTreeState.getExpandLevels()};d=l(e.buildApply4Hierarchy(t,this.mQueryOptions))}else{const n=o.getPrivateAnnotation(t,"parent",this.oFirstLevel);d=s?e.dropFilter(this.oAggregation,this.mQueryOptions,n.$parentFilter):l(n.getQueryOptions())}d.$filter=o.getKeyFilter(t,this.sMetaPath,this.getTypes());const u=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,d,false,true);const h=await this.oRequestor.request("GET",u,i.getUnlockedCopy(),undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,{$select:n},this);const c=h.value[0];if(r&&c){n.forEach(e=>{o.inheritPathValue(e.split("/"),c,t,true)})}else{return c}};u.prototype.requestRank=async function(e,t,n){const i=await this.requestProperties(e,[this.oAggregation.$LimitedRank],t,false,false,n);return i&&parseInt(o.drillDown(i,this.oAggregation.$LimitedRank))};u.prototype.requestSiblingIndex=async function(e,t,n){const i=this.getSiblingIndex(e,t,true);if(i!==undefined){return i}const r=this.aElements[e];const s={...this.oFirstLevel.mQueryOptions,$filter:this.oAggregation.$LimitedRank+(t<0?" lt ":" gt ")+o.getPrivateAnnotation(r,"rank")+" and "+this.oAggregation.$DistanceFromRoot+" lt "+r["@$ui5.node.level"],$top:1};if(t<0){s.$orderby=this.oAggregation.$LimitedRank+" desc"}s.$select=[...s.$select,this.oAggregation.$LimitedRank];delete s.$count;const a=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,s,false,true,true);const l=await this.oRequestor.request("GET",a,n);const d=l.value[0];this.oFirstLevel.calculateKeyPredicate(d,this.getTypes(),this.sMetaPath);const u=parseInt(o.drillDown(d,this.oAggregation.$LimitedRank));o.deleteProperty(d,this.oAggregation.$LimitedRank);if(o.hasPrivateAnnotation(this.aElements[u],"placeholder")){this.insertNode(d,u)}return d["@$ui5.node.level"]===r["@$ui5.node.level"]?u:-1};u.prototype.reset=function(t,n,i,r,s){if(s){throw new Error("Unsupported grouping via sorter")}for(const e in t){const t=this.aElements.$byPredicate[e];if(o.hasPrivateAnnotation(t,"placeholder")){throw new Error("Unexpected placeholder")}delete t["@$ui5.node.isExpanded"];delete t["@$ui5.node.level"];delete t["@$ui5._"];o.setPrivateAnnotation(t,"predicate",e)}const a=this.oFirstLevel.reset;a.call(this,t,n,i);if(n){this.oBackup.oCountPromise=this.oCountPromise;this.oBackup.oFirstLevel=this.oFirstLevel;this.oBackup.oGrandTotalPromise=this.oGrandTotalPromise;this.oBackup.bUnifiedCache=this.bUnifiedCache;this.bUnifiedCache=!!r.hierarchyQualifier}else{this.oTreeState.reset()}r=Object.assign({},r);r.$ExpandLevels=this.oTreeState.getExpandLevels();this.doReset(r,e.hasGrandTotal(r.aggregate))};u.prototype.resetOutOfPlace=function(){this.oTreeState.resetOutOfPlace()};u.prototype.restore=function(e){if(e){this.oCountPromise=this.oBackup.oCountPromise;this.oFirstLevel=this.oBackup.oFirstLevel;this.oGrandTotalPromise=this.oBackup.oGrandTotalPromise;this.bUnifiedCache=this.oBackup.bUnifiedCache}const t=this.oFirstLevel.restore;t.call(this,e)};u.prototype.shiftRank=function(e,t){const n=this.aElements[e];const i=o.getPrivateAnnotation(n,"rank");if(i===undefined){return}const r=o.getPrivateAnnotation(n,"parent");if(r===this.oFirstLevel){e=-1}for(let s=e+1;s<this.aElements.length;s+=1){const e=this.aElements[s];if(e===n){continue}if(o.getPrivateAnnotation(e,"parent")===r){const n=o.getPrivateAnnotation(e,"rank");if(n>=i){o.setPrivateAnnotation(e,"rank",n+t)}}if(r!==this.oFirstLevel&&e["@$ui5.node.level"]<n["@$ui5.node.level"]){break}}};u.prototype.shiftRankForMove=function(e,t,n){if(e<n){this.aElements.forEach(i=>{const r=o.getPrivateAnnotation(i,"rank");if(e+t<=r&&r<n+t){o.setPrivateAnnotation(i,"rank",r-t)}})}else if(n<e){this.aElements.forEach(i=>{const r=o.getPrivateAnnotation(i,"rank");if(n<=r&&r<e){o.setPrivateAnnotation(i,"rank",r+t)}})}};u.prototype.toString=function(){return this.sToString};u.prototype.turnIntoPlaceholder=function(t,n){if(o.hasPrivateAnnotation(t,"placeholder")){return}o.setPrivateAnnotation(t,"placeholder",1);e.markSplicedStale(t);delete this.aElements.$byPredicate[n];const i=o.getPrivateAnnotation(t,"rank");if(i!==undefined){o.getPrivateAnnotation(t,"parent").drop(i,n,true)}};u.prototype.validateAndDeleteExpandInfo=async function(t,n){const i=this.oTreeState.getExpandFilters(e=>{const t=this.aElements.$byPredicate[e];return!this.aElements.includes(t)});if(!i.length){return}const r=this.getTypes();let s={...this.mQueryOptions};s.$$filterBeforeAggregate=o.getKeyFilter(n,this.sMetaPath,r);delete s.$count;delete s.$expand;delete s.$orderby;s=e.buildApply4Hierarchy(this.oAggregation,s,true);s.$filter=i.sort().join(" or ");s.$select=[];o.selectKeyProperties(s,r[this.sMetaPath]);s.$top=i.length;const a=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,s,false,true,true);const l=await this.oRequestor.request("GET",a,this.oRequestor.getUnlockedAutoCopy(t));l.value.forEach(e=>{this.calculateKeyPredicate(e,r,this.sMetaPath);this.oTreeState.deleteExpandInfo(e)})};u.calculateKeyPredicate=function(t,n,i,r,s,a,l,d){var u;if(!(d in l)){return undefined}if(t){i.forEach(function(e){if(Array.isArray(e)){o.inheritPathValue(e,t,a)}else if(!(e in a)){if(t[e+"@$ui5.noData"]){a[e+"@$ui5.noData"]=true}a[e]=t[e]}})}u=r&&o.getKeyPredicate(a,d,l)||o.getKeyPredicate(a,d,l,n,true);o.setPrivateAnnotation(a,"predicate",u);if(!r){o.setPrivateAnnotation(a,"filter",o.getKeyFilter(a,d,l,n))}e.setAnnotations(a,r?undefined:false,s,t?t["@$ui5.node.level"]+1:1,t?null:i);return u};u.calculateKeyPredicateRH=function(t,n,i,r,s){var a,l,d=1,u,h;if(!(s in r)){return undefined}h=o.getKeyPredicate(i,s,r);o.setPrivateAnnotation(i,"predicate",h);if(s!==n.$metaPath){return h}switch(o.drillDown(i,n.$DrillState)){case"expanded":l=true;break;case"collapsed":l=false;break;default:}o.deleteProperty(i,n.$DrillState);if(t){d=t["@$ui5.node.level"]+1}else{a=o.drillDown(i,n.$DistanceFromRoot);if(a){o.deleteProperty(i,n.$DistanceFromRoot);d=parseInt(a)+1}}e.setAnnotations(i,l,undefined,d);if(n.$LimitedDescendantCount){u=o.drillDown(i,n.$LimitedDescendantCount);if(u){o.deleteProperty(i,n.$LimitedDescendantCount);if(u!=="0"){o.setPrivateAnnotation(i,"descendants",parseInt(u))}}}return h};u.create=function(n,i,o,s,a,l,d,h){var c,f;function g(){if("$expand"in s){throw new Error("Unsupported system query option: $expand")}if("$select"in s){throw new Error("Unsupported system query option: $select")}}if(a){c=e.hasGrandTotal(a.aggregate);f=a.groupLevels&&!!a.groupLevels.length;if(e.hasMinOrMax(a.aggregate)){if(c){throw new Error("Unsupported grand totals together with min/max")}if(f){throw new Error("Unsupported group levels together with min/max")}if(a.hierarchyQualifier){throw new Error("Unsupported recursive hierarchy together with min/max")}if(d){throw new Error("Unsupported $$sharedRequest together with min/max")}g();return r.createCache(n,i,a,s)}if(s.$filter&&(c&&!a["grandTotal like 1.84"]||f)){throw new Error("Unsupported system query option: $filter")}if(c||f||a.hierarchyQualifier){if(s.$search){throw new Error("Unsupported system query option: $search")}if(!a.hierarchyQualifier){g()}if(h){throw new Error("Unsupported grouping via sorter")}if(d){throw new Error("Unsupported $$sharedRequest")}return new u(n,i,a,s,c)}}if("$$filterOnAggregate"in s){throw new Error("Unsupported $$filterOnAggregate")}if(s.$$filterBeforeAggregate){s={...s,$apply:"filter("+s.$$filterBeforeAggregate+")/"+s.$apply};delete s.$$filterBeforeAggregate}return t.create(n,i,s,l,o,d)};u.fixDuplicatePredicate=function(e,t){if(t==="('')"||t.includes("=''")){a.warning("Duplicate key predicate: "+t,this.toString(),"sap.ui.model.odata.v4.lib._AggregationCache");const n=t.slice(0,-1)+",$duplicate="+o.uid()+")";o.setPrivateAnnotation(e,"predicate",n);if(this.aElements.$byPredicate[t]===e){delete this.aElements.$byPredicate[t];this.aElements.$byPredicate[n]=e}return n}};return u},false);
//# sourceMappingURL=_AggregationCache.js.map