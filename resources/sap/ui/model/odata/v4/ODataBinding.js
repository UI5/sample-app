/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v4/Context"],function(e,t,n,r,i){"use strict";var o=[n.Context,n.Change,n.Refresh,n.Sort,n.Filter],s=/\/\d|\(\$uid=/;function a(e,t){return o.indexOf(e)>o.indexOf(t)}function h(){this.mCacheByResourcePath=undefined;this.oCache=null;this.oCachePromise=t.resolve(null);this.mCacheQueryOptions=undefined;this.fnDeregisterChangeListener=undefined;this.oFetchCacheCallToken=undefined;this.sReducedPath=undefined;this.sResumeChangeReason=undefined}h.prototype._hasPendingChanges=function(e,t){return this.isResolved()&&(this.hasPendingChangesForPath("",e)||this.hasPendingChangesInDependents(e,t))};h.prototype._resetChanges=function(e){var t=[];this.checkSuspended();this.resetChangesForPath("",t);this.resetChangesInDependents(t,e);this.resetInvalidDataState();return Promise.all(t).then(function(){})};h.prototype.adjustPredicate=function(e,t){this.sReducedPath=this.sReducedPath.replace(e,t)};h.prototype.checkBindingParameters=function(t,n){var i=this;Object.keys(t).forEach(function(o){var s=t[o];if(!o.startsWith("$$")){return}if(!n.includes(o)){throw new Error("Unsupported binding parameter: "+o)}switch(o){case"$$aggregation":break;case"$$groupId":case"$$updateGroupId":e.checkGroupId(s,false,"Unsupported value for binding parameter '"+o+"': ");break;case"$$ignoreMessages":case"$$sharedRequest":if(s!==true&&s!==false){throw new Error("Unsupported value for binding parameter '"+o+"': "+s)}break;case"$$inheritExpandSelect":if(s!==true&&s!==false){throw new Error("Unsupported value for binding parameter "+"'$$inheritExpandSelect': "+s)}if(!i.oOperation){throw new Error("Unsupported binding parameter $$inheritExpandSelect: "+"binding is not an operation binding")}if(t.$expand){throw new Error("Must not set parameter $$inheritExpandSelect on a binding "+"which has a $expand binding parameter")}break;case"$$operationMode":if(s!==r.Server){throw new Error("Unsupported operation mode: "+s)}break;case"$$getKeepAliveContext":if(i.isRelative()&&!t.$$ownRequest){throw new Error("$$getKeepAliveContext requires $$ownRequest in a relative binding")}["$$aggregation","$$canonicalPath","$$sharedRequest"].forEach(function(n,r){if(n in t&&(r>0||e.isDataAggregation(t))){throw new Error("Cannot combine $$getKeepAliveContext and "+n)}});case"$$canonicalPath":case"$$clearSelectionOnFilter":case"$$noPatch":case"$$ownRequest":case"$$patchWithoutSideEffects":if(s!==true){throw new Error("Unsupported value for binding parameter '"+o+"': "+s)}break;case"$$separate":if(t.$$aggregation){throw new Error("Cannot combine $$aggregation and $$separate")}break;default:throw new Error("Unknown binding-specific parameter: "+o)}})};h.prototype.checkSameCache=function(e,t){var n;if(this.oCache!==e||t!==undefined&&this.oCache.iResetCount!==t){n=new Error(this+" is ignoring response from inactive cache: "+e);n.canceled=true;throw n}};h.prototype.checkSuspended=function(e){if(this.isRootBindingSuspended()&&(!e||this.isRoot()||this.getResumeChangeReason())){throw new Error("Must not call method when the binding's root binding is suspended: "+this)}};h.prototype.checkTransient=function(){if(this.isTransient()){throw new Error("Must not call method when the binding is part of a deep create: "+this)}};h.prototype.checkUpdate=function(e){if(arguments.length>1){throw new Error("Only the parameter bForceUpdate is supported")}this.checkUpdateInternal(e).catch(this.oModel.getReporter())};h.prototype.createAndSetCache=function(e,t,n,r,i,o){var s,a,h;this.mCacheQueryOptions=Object.assign({},this.oModel.mURLParameters,e);if(this.bRelative){s=this.mCacheByResourcePath&&this.mCacheByResourcePath[t];h=n.getGeneration?.()??0;if(s&&s.$generation>=h){s.setActive(true)}else{a=this.oModel.resolve(this.sPath,n).slice(1);s=this.doCreateCache(t,this.mCacheQueryOptions,n,a,r,i,o);if(!(this.mParameters&&this.mParameters.$$sharedRequest)){this.mCacheByResourcePath??={};this.mCacheByResourcePath[t]=s}s.$deepResourcePath=a;s.$generation=h}}else{s=this.doCreateCache(t,this.mCacheQueryOptions,undefined,undefined,r,i,o)}if(o&&o!==s){this.deregisterChangeListener();o.setActive(false)}if(this.mLateQueryOptions){s.setLateQueryOptions(this.mLateQueryOptions,true)}this.oCache=s;return s};h.prototype.deregisterChangeListener=function(){this.fnDeregisterChangeListener?.();this.fnDeregisterChangeListener=undefined};h.prototype.destroy=function(){this.mCacheByResourcePath=undefined;this.deregisterChangeListener();this.oCachePromise.then(function(e){e?.setActive(false)},function(){});this.oCache=null;this.oCachePromise=t.resolve(null);this.mCacheQueryOptions=undefined;this.oContext=undefined;this.oFetchCacheCallToken=undefined};h.prototype.getEventingParent=function(){return this.oModel};h.prototype.fetchCache=function(e,n,r,i,o,s){var a=this.oCache,h={oOldCache:a===undefined?this.oFetchCacheCallToken.oOldCache:a},u,c=this;if(!this.bRelative){e=undefined}if(!a&&r){if(a===undefined){throw new Error("Unsupported bKeepQueryOptions while oCachePromise is pending")}return}if(s&&!r){throw new Error("Unsupported bSync w/o bKeepQueryOptions")}this.oCache=undefined;this.oFetchCacheCallToken=h;if(r){this.oCachePromise=t.resolve(s||Promise.resolve()).then(function(){return c.createAndSetCache(c.mCacheQueryOptions,a.getResourcePath(),e,i,o,a)});return}u=[this.fetchOrGetQueryOptionsForOwnCache(e,n),this.oModel.oRequestor.ready()];this.mCacheQueryOptions=undefined;this.oCachePromise=t.all(u).then(function(t){var n=t[0].mQueryOptions;if(h.initiallySuspended){return null}if(t[0].sReducedPath){c.sReducedPath=t[0].sReducedPath}if(!c.prepareDeepCreate(e,n)){return c.fetchResourcePath(e).then(function(t){if(c.oFetchCacheCallToken!==h){return c.oCachePromise.then(function(e){if(e===h.oOldCache){return e}const t=new Error("Cache discarded as a new cache has been created");t.canceled=true;throw t})}return c.oModel.waitForKeepAliveBinding(c).then(function(){c.oFetchCacheCallToken=undefined;return c.createAndSetCache(n,t,e,i,o,h.oOldCache)})})}h.oOldCache=undefined;if(a){a.setActive(false)}c.oCache=null;return null});this.oCachePromise.catch(this.oModel.getReporter())};h.prototype.fetchOrGetQueryOptionsForOwnCache=function(n,r){var i,o,s=this.oModel.resolve(this.sPath,n),a=this;function h(t,n,r){if(n&&t&&e.isEmptyObject(t)){t=undefined}return{mQueryOptions:t,sReducedPath:r||s}}function u(e,n){if(o instanceof t){if(!o.isFulfilled()){return o.then(function(t){return h(t,e,n)})}o=o.getResult()}return h(o,e,n)}if(this.oOperation||!s||this.isMeta()){return h()}o=this.doFetchOrGetQueryOptions(n);if(this.oModel.bAutoExpandSelect&&this.aChildCanUseCachePromises&&!e.isDataAggregation(this.mParameters)){o=t.all([o,Promise.resolve().then(function(){return t.all(a.aChildCanUseCachePromises)})]).then(function(e){a.aChildCanUseCachePromises=[];a.updateAggregatedQueryOptions(e[0]);return a.mAggregatedQueryOptions})}if(r||!this.bRelative||!n.fetchValue){return u()}if(this.oModel.bAutoExpandSelect){i=this.mParameters&&Object.keys(a.mParameters).some(function(e){return e[0]!=="$"||e[1]==="$"});if(i){return u()}return n.getBinding().fetchIfChildCanUseCache(n,a.sPath,o,!this.mParameters).then(function(e){if(e){o=undefined}else{o??={}}return u(false,e)})}if(this.mParameters&&!e.isEmptyObject(this.mParameters)){return u()}return u(true)};h.prototype.fetchResourcePath=function(n){var r,i,o,a=this;if(!this.bRelative){return t.resolve(this.sPath.slice(1))}n??=this.oContext;if(!n){return t.resolve()}i=n.getPath();r=n.fetchCanonicalPath&&(this.mParameters&&this.mParameters.$$canonicalPath||!this.isTransient()&&s.test(i));o=r?n.fetchCanonicalPath():t.resolve(i);return o.then(function(t){return e.buildPath(t,a.sPath).slice(1)})};h.prototype.fireDataReceived=function(e,t){this.fireEvent("dataReceived",e,false,!t)};h.prototype.fireDataRequested=function(e){this.fireEvent("dataRequested",undefined,false,!e)};h.prototype.getGroupId=function(){return this.sGroupId||this.bRelative&&this.oContext&&this.oContext.getGroupId&&this.oContext.getGroupId()||this.oModel.getGroupId()};h.prototype.getRelativePath=function(t){var n;if(t[0]==="/"){n=e.getRelativePath(t,this.getResolvedPath());if(n===undefined&&this.oReturnValueContext){n=e.getRelativePath(t,this.oReturnValueContext.getPath())}return n}return t};h.prototype.getResumeChangeReason=function(){var e=this.sResumeChangeReason;this.getDependentBindings().forEach(function(t){var n=t.getResumeChangeReason();if(n&&a(n,e)){e=n}});return e};h.prototype.getRootBinding=function(){if(this.bRelative){if(!this.oContext){return undefined}if(this.oContext.getBinding){return this.oContext.getBinding().getRootBinding()}}return this};h.prototype.getRootBindingResumePromise=function(){var e=this.getRootBinding();return e&&e.getResumePromise()||t.resolve()};h.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.bRelative&&this.oContext&&this.oContext.getUpdateGroupId&&this.oContext.getUpdateGroupId()||this.oModel.getUpdateGroupId()};h.prototype.hasPendingChanges=function(e){return this._hasPendingChanges(e)};h.prototype.hasPendingChangesForPath=function(e,t){return this.withCache(function(e,n,r){return e.hasPendingChangesForPath(n,t,t&&(r.isRoot()||r.mParameters.$$ownRequest))},e,true).unwrap()};h.prototype.hasPendingChangesInCaches=function(e){var t=this;if(!this.mCacheByResourcePath){return false}return Object.keys(this.mCacheByResourcePath).some(function(n){var r=t.mCacheByResourcePath[n];return r.$deepResourcePath.startsWith(e)&&r.hasPendingChangesForPath("")})};h.prototype.isInitial=function(){throw new Error("Unsupported operation: isInitial")};h.prototype.isRoot=function(){return!this.bRelative||this.oContext&&!this.oContext.getBinding};h.prototype.isRootBindingSuspended=function(){var e=this.getRootBinding();return e&&e.isSuspended()};h.prototype.isTransient=function(){return this.bRelative&&this.oContext?.getPath().includes("($uid=")};h.prototype.lockGroup=function(e,t,n,r){e??=n?this.getUpdateGroupId():this.getGroupId();return this.oModel.lockGroup(e,this,t,n,r)};h.prototype.prepareDeepCreate=function(e,t){if(e){if(e.iIndex===i.VIRTUAL){return true}if(e.getPath().includes("($uid=")){this.mCacheQueryOptions=t;return true}}return!t};h.prototype.ready=function(){return this.oCachePromise};h.prototype.refresh=function(e){if(typeof e==="boolean"){throw new Error("Unsupported parameter bForceUpdate")}this.requestRefresh(e).catch(this.oModel.getReporter())};h.prototype.refreshSuspended=function(e){if(e&&e!==this.getGroupId()){throw new Error(this+": Cannot refresh a suspended binding with group ID '"+e+"' (own group ID is '"+this.getGroupId()+"')")}this.setResumeChangeReason(n.Refresh)};h.prototype.removeCachesAndMessages=function(t,n){var r=this;if(!n&&this.oCache){this.oCache.removeMessages()}if(this.mCacheByResourcePath){Object.keys(this.mCacheByResourcePath).forEach(function(i){var o=r.mCacheByResourcePath[i],s=o.$deepResourcePath;if(e.hasPathPrefix(s,t)){if(!n){o.removeMessages()}delete r.mCacheByResourcePath[i]}})}};h.prototype.requestAbsoluteSideEffects=function(t,n){var r=[],i=e.getMetaPath(this.getResolvedPath());if(this.oCache===undefined){return undefined}n.some(function(t){var n=e.getRelativePath(t,i);if(n!==undefined){r.push(n)}else if(e.hasPathPrefix(i,t)){r=[""];return true}});if(r.length){if(this.requestSideEffects){return this.requestSideEffects(t,r)}return this.refreshInternal("",t,true,true)}};h.prototype.requestRefresh=function(t){if(!this.mParameters?.$$ownRequest&&!this.isRoot()){throw new Error("Refresh on this binding is not supported")}if(this.hasPendingChanges(true)){throw new Error("Cannot refresh due to pending changes")}e.checkGroupId(t);return Promise.resolve(this.refreshInternal("",t,true)).then(function(){})};h.prototype.resetChanges=function(){this.checkTransient();return this._resetChanges()};h.prototype.resetChangesForPath=function(e,t){t.push(this.withCache(function(e,t){e.resetChangesForPath(t)},e).unwrap())};h.prototype.resetInvalidDataState=function(){};h.prototype.setDeregisterChangeListener=function(e){this.fnDeregisterChangeListener=e};h.prototype.setResumeChangeReason=function(e){if(a(e,this.sResumeChangeReason)){this.sResumeChangeReason=e}};h.prototype.toString=function(){return this.getMetadata().getName()+": "+(this.bRelative?this.oContext+"|":"")+this.sPath};h.prototype.withCache=function(n,r="",i=false,o=false){var s=i?t.resolve(this.oCache):this.oCachePromise,a,h=this;return s.then(function(t){if(t){a=h.getRelativePath(r);if(a!==undefined){return n(t,a,h)}}else if(t===undefined){return undefined}else if(h.oOperation){return o?n(null,h.getRelativePath(r),h):undefined}if(h.bRelative&&h.oContext&&h.oContext.withCache){return h.oContext.withCache(n,r[0]==="/"?r:e.buildPath(h.sPath,r),i,o)}return undefined})};function u(e){if(this){h.apply(this,arguments)}else{Object.assign(e,h.prototype)}}["adjustPredicate","destroy","hasPendingChangesForPath"].forEach(function(e){u.prototype[e]=h.prototype[e]});return u},false);
//# sourceMappingURL=ODataBinding.js.map