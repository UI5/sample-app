/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./library","sap/m/library","sap/ui/core/ControlBehavior","sap/ui/core/Element","sap/ui/core/LabelEnablement","sap/ui/core/InvisibleText","sap/m/delegate/ValueStateMessage","sap/m/Button","sap/m/Tokenizer","sap/m/Token","sap/ui/core/Icon","sap/ui/core/Lib","sap/ui/core/library","sap/ui/core/StaticArea","sap/ui/Device","./FileUploaderRenderer","sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/Log","sap/base/security/encodeXML","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/Aria"],function(e,t,i,s,o,r,a,l,n,p,u,h,f,d,c,g,y,m,_,F,b,jQuery){const T=d.ValueState;const v=t.FileUploaderHttpRequestMethod;const A=i.TokenizerRenderMode;var U=e.extend("sap.ui.unified.FileUploader",{metadata:{interfaces:["sap.ui.core.IFormContent","sap.ui.unified.IProcessableBlobs"],library:"sap.ui.unified",designtime:"sap/ui/unified/designtime/FileUploader.designtime",properties:{value:{type:"string",group:"Data",defaultValue:""},enabled:{type:"boolean",group:"Behavior",defaultValue:true},uploadUrl:{type:"sap.ui.core.URI",group:"Data",defaultValue:""},name:{type:"string",group:"Data",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:""},uploadOnChange:{type:"boolean",group:"Behavior",defaultValue:false},additionalData:{type:"string",group:"Data",defaultValue:null},sameFilenameAllowed:{type:"boolean",group:"Behavior",defaultValue:false},buttonText:{type:"string",group:"Misc",defaultValue:null},fileType:{type:"string[]",group:"Data",defaultValue:null},multiple:{type:"boolean",group:"Behavior",defaultValue:false},maximumFileSize:{type:"float",group:"Data",defaultValue:null},mimeType:{type:"string[]",group:"Data",defaultValue:null},sendXHR:{type:"boolean",group:"Behavior",defaultValue:false},httpRequestMethod:{type:"sap.ui.unified.FileUploaderHttpRequestMethod",group:"Behavior",defaultValue:v.Post},placeholder:{type:"string",group:"Appearance",defaultValue:null},style:{type:"string",group:"Appearance",defaultValue:null},buttonOnly:{type:"boolean",group:"Appearance",defaultValue:false},useMultipart:{type:"boolean",group:"Behavior",defaultValue:true},maximumFilenameLength:{type:"int",group:"Data",defaultValue:null},valueState:{type:"sap.ui.core.ValueState",group:"Data",defaultValue:T.None},valueStateText:{type:"string",group:"Misc",defaultValue:null},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconHovered:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconSelected:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:""},iconFirst:{type:"boolean",group:"Appearance",defaultValue:true},iconOnly:{type:"boolean",group:"Appearance",defaultValue:false},directory:{type:"boolean",group:"Behavior",defaultValue:false},required:{type:"boolean",group:"Behavior",defaultValue:false}},aggregations:{parameters:{type:"sap.ui.unified.FileUploaderParameter",multiple:true,singularName:"parameter"},headerParameters:{type:"sap.ui.unified.FileUploaderParameter",multiple:true,singularName:"headerParameter"},xhrSettings:{type:"sap.ui.unified.FileUploaderXHRSettings",multiple:false},_tokenizer:{type:"sap.m.Tokenizer",multiple:false,visibility:"hidden"},_browseIcon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},_clearIcon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{change:{parameters:{newValue:{type:"string"},files:{type:"object[]"}}},uploadComplete:{parameters:{fileName:{type:"string"},response:{type:"string"},readyStateXHR:{type:"string"},status:{type:"int"},responseRaw:{type:"string"},headers:{type:"object"},requestHeaders:{type:"object[]"}}},typeMissmatch:{parameters:{fileName:{type:"string"},fileType:{type:"string"},mimeType:{type:"string"}}},fileSizeExceed:{parameters:{fileName:{type:"string"},fileSize:{type:"string"}}},fileEmpty:{parameters:{fileName:{type:"string"}}},fileAllowed:{},uploadProgress:{parameters:{lengthComputable:{type:"boolean"},loaded:{type:"float"},total:{type:"float"},fileName:{type:"string"},requestHeaders:{type:"object[]"}}},uploadAborted:{parameters:{fileName:{type:"string"},requestHeaders:{type:"object[]"}}},filenameLengthExceed:{parameters:{fileName:{type:"string"}}},uploadStart:{parameters:{fileName:{type:"string"},requestHeaders:{type:"object[]"}}},beforeDialogOpen:{},afterDialogClose:{}}},renderer:y});U.prototype.init=function(){this.oRb=f.getResourceBundleFor("sap.ui.unified");this.oBrowse=new n(this.getId()+"-fu_button");this.oBrowse.setParent(this);this._oBrowseDelegate={onAfterRendering:()=>{const e=this.oBrowse.getDomRef();e.setAttribute("tabindex","-1");e.removeAttribute("aria-labelledby");e.removeAttribute("aria-describedby")}};this.oBrowse.addEventDelegate(this._oBrowseDelegate);this._oTokenizerDelegate={onfocusin:()=>{if(!this._bTokenizerFocus&&this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}this._bTokenizerFocus=true;this._removeFocusClass()}};this.oFileUpload=null;if(s.isAccessibilityEnabled()){if(!U.prototype._sAccText){U.prototype._sAccText=this.oRb.getText("FILEUPLOADER_ACC_TEXT")}}this._submitAfterRendering=false;this._selectedFileNames=[];this._bTokenizerFocus=false;this._oValueStateMessage=new l(this)};U.prototype.setIcon=function(e){this.oBrowse.setIcon(e);this.setProperty("icon",e,false);return this};U.prototype.setIconHovered=function(e){this.setProperty("iconHovered",e,false);if(this.oBrowse.setIconHovered){this.oBrowse.setIconHovered(e)}return this};U.prototype.setIconSelected=function(e){this.setProperty("iconSelected",e,false);if(this.oBrowse.setIconSelected){this.oBrowse.setIconSelected(e)}else{this.oBrowse.setActiveIcon(e)}return this};U.prototype.setIconFirst=function(e){this.oBrowse.setIconFirst(e);this.setProperty("iconFirst",e,false);return this};U.prototype.setName=function(e){this.setProperty("name",e,false);this._rerenderInputField();return this};U.prototype.setFileType=function(e){var t=this._convertTypesToArray(e);this.setProperty("fileType",t,false);this._rerenderInputField();return this};U.prototype.setMimeType=function(e){var t=this._convertTypesToArray(e);this.setProperty("mimeType",t,false);this._rerenderInputField();return this};U.prototype.setMultiple=function(e){this.setProperty("multiple",e,false);this._rerenderInputField();return this};U.prototype.setDirectory=function(e){this.setProperty("directory",e,false);this._rerenderInputField();return this};U.prototype._rerenderInputField=function(){if(this.oFileUpload){var e=this.oFileUpload.files;this._clearInputField();this._prepareFileUpload();jQuery(this.oFileUpload).on("change",this.handlechange.bind(this));this.oFileUpload.files=e;this._cacheDOMEls()}};U.prototype.setTooltip=function(t){var i;e.prototype.setTooltip.call(this,t);if(this.oFileUpload){i=this.getTooltip_AsString();if(i){this.oFileUpload.setAttribute("title",i)}else{this.oFileUpload.setAttribute("title",this.getValue()?this.getValue():this._getNoFileChosenText())}}return this};U.prototype._addFocusClass=function(){this.getDomRef().classList.add("sapMFocus")};U.prototype._removeFocusClass=function(){this.getDomRef().classList.remove("sapMFocus")};U.prototype._getTokenizer=function(){let e=this.getAggregation("_tokenizer");if(!e){e=new p(this.getId()+"-fu_tokenizer",{editable:false,width:"100%"});e.addEventDelegate(this._oTokenizerDelegate);e._getTokenToFocus=()=>this._bTokenizerFocus?p.prototype._getTokenToFocus.apply(e,arguments):null;this.setAggregation("_tokenizer",e)}return e};U.prototype._getBrowseIcon=function(){let e=this.getAggregation("_browseIcon");if(!e){e=new h(this.getId()+"-fu_browse_icon",{src:"sap-icon://value-help",press:this._onBrowseIconPress.bind(this),noTabStop:true});this.setAggregation("_browseIcon",e)}return e};U.prototype._getClearIcon=function(){let e=this.getAggregation("_clearIcon");if(!e){e=new h(this.getId()+"-fu_clear_icon",{src:"sap-icon://decline",tooltip:this.oRb.getText("FILEUPLOADER_CLEAR_ICON_TOOLTIP"),press:this._onClearIconPress.bind(this),noTabStop:true});this.setAggregation("_clearIcon",e)}return e};U.prototype._onBrowseIconPress=function(e){if(this.getEnabled()){this.fireBeforeDialogOpen();this.openFilePicker(e)}};U.prototype._onClearIconPress=function(e){if(this.getEnabled()){this._clearSelectedFiles();if(e){e.preventDefault();e.stopPropagation&&e.stopPropagation()}}};U.prototype._clearSelectedFiles=function(){if(this._selectedFileNames.length>0){this.clear();this.fireChange({newValue:"",files:[]})}};U.prototype._updateTokenizer=function(){const e=this._getTokenizer();e.removeAllTokens();this._selectedFileNames.forEach(t=>{e.addToken(new u({text:t,tooltip:t,selected:false}))});this._bFocusFileUploader=true};U.prototype._generateAccDescriptionText=function(){const e=this.getTooltip_AsString(),t=this.getPlaceholder(),i=this.getValue();let s="";if(e){s+=e+" "}if(i){s+=i+" "}else if(t&&!this.getButtonOnly()){s+=t+" "}s+=this._sAccText;return s};U.prototype._convertTypesToArray=function(e){if(typeof e==="string"){if(e===""){return[]}else{return e.split(",").map(function(e){return e.trim()})}}return e};U.prototype.exit=function(){const e=this.getAggregation("_tokenizer"),t=this.getAggregation("_clearIcon"),i=this.getAggregation("_browseIcon");this._detachLabelClickHandlers();this.oBrowse.removeEventDelegate(this._oBrowseDelegate);this._oBrowseDelegate=null;this.oBrowse.destroy();this.oBrowse=null;if(e){e.removeEventDelegate(this._oTokenizerDelegate);this._oTokenizerDelegate=null;e.destroy()}if(t){t.destroy()}if(i){i.destroy()}this._oValueStateMessage.destroy();this._oValueStateMessage=null;if(this.oIFrameRef){jQuery(this.oIFrameRef).off();c.getDomRef().removeChild(this.oIFrameRef);this.oIFrameRef=null}if(this.oFileUpload){this._clearInputField()}if(this.FUEl){this.FUEl=null}if(this.FUDataEl){this.FUDataEl=null}};U.prototype._clearInputField=function(){jQuery(this.oFileUpload).off();this.oFileUpload.parentElement.removeChild(this.oFileUpload);this.oFileUpload=null};U.prototype.onBeforeRendering=function(){const e=c.getDomRef(),t=this.getButtonOnly(),i=this.getTooltip_AsString()||this._getBrowseIconTooltip();jQuery(this.oFileUpload).appendTo(e);if(!this.getName()){F.warning("Name property is not set. It would be used instead to identify the control on the server.",this)}jQuery(this.oFileUpload).off();if(!t){this._getBrowseIcon().setTooltip(this._getBrowseIconTooltip())}else if(this.getIconOnly()&&t){this.oBrowse.setText("");this.oBrowse.setTooltip(i)}else if(this.getIconOnly()){this.oBrowse.setText("");this.oBrowse.setTooltip(i)}else{this.oBrowse.setText(this._getEffectiveButtonText());this.oBrowse.setTooltip(i)}};U.prototype.onAfterRendering=function(){this._attachLabelClickHandlers();this.prepareFileUploadAndIFrame();this._cacheDOMEls();this._addLabelFeaturesToBrowse();jQuery(this.oFileUpload).on("change",this.handlechange.bind(this));if(this._submitAfterRendering){this._submitAndResetValue();this._submitAfterRendering=false}this._attachContainerClickHandler()};U.prototype._attachLabelClickHandlers=function(){this._detachLabelClickHandlers();this._bLabelClickInProgress=false;this._labelClickHandlers=[];r.getReferencingLabels(this).forEach(e=>{const t=document.getElementById(e);if(t){const e=()=>{this._bLabelClickInProgress=true;setTimeout(()=>{this._bLabelClickInProgress=false},0)};this._labelClickHandlers.push({element:t,handler:e});t.addEventListener("click",e)}})};U.prototype._detachLabelClickHandlers=function(){if(this._labelClickHandlers){this._labelClickHandlers.forEach(({element:e,handler:t})=>{e.removeEventListener("click",t)});this._labelClickHandlers=[]}this._bLabelClickInProgress=false};U.prototype._attachContainerClickHandler=function(){this.$().off("click.fileuploader").on("click.fileuploader",e=>{if(this._bLabelClickInProgress){e.preventDefault();e.stopPropagation();this.oFileUpload.focus();return}if(e.target.classList.contains("sapMToken")||e.target.classList.contains("sapMTokenizer")||e.target.classList.contains("sapMTokenizerIndicator")||jQuery(e.target).closest(".sapMToken, .sapMTokenizerIndicator").length>0){return}const t=jQuery(e.target).closest(".sapUiIcon");if(t.length>0){const e=this._getBrowseIcon(),i=this._getClearIcon();if(t[0]===e.getDomRef()||t[0]===i.getDomRef()){return}}const i=jQuery(e.target).closest(".sapUiFupBrowseIcon");if(i.length>0){if(this.getEnabled()){this.fireBeforeDialogOpen();this.openFilePicker()}return}const s=jQuery(e.target).closest(".sapUiFupClearIcon");if(s.length>0){if(this.getEnabled()){this._clearSelectedFiles()}return}if(e.target===this.oFileUpload){return}if(this.getButtonOnly()&&(e.target===this.oBrowse.getDomRef()||jQuery(e.target).closest(this.oBrowse.getDomRef()).length>0)){this.oBrowse.getDomRef().blur();this.oFileUpload.focus();return}if(this.getEnabled()){this.openFilePicker()}})};U.prototype._cacheDOMEls=function(){this.FUEl=this.getDomRef("fu");this.FUDataEl=this.getDomRef("fu_data")};U.prototype.getIdForLabel=function(){return this.getId()+"-fu"};U.prototype.onfocusin=function(e){const t=this.getButtonOnly();if(t){this.oBrowse.getDomRef().blur();this.oFileUpload.focus()}if(this._bTokenizerFocus){return}if(!t&&!this._bTokenizerFocus&&this._selectedFileNames.length>0){this._getTokenizer().setRenderMode(A.Loose)}this._addFocusClass();if(this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}};U.prototype.onsapfocusleave=function(e){if(!this.getButtonOnly()&&!this._bTokenizerFocus&&this._selectedFileNames.length>0){this._getTokenizer().setRenderMode(A.Narrow)}this._bTokenizerFocus=false;this._removeFocusClass();if(!e.relatedControlId||!m(this.getDomRef(),o.getElementById(e.relatedControlId).getFocusDomRef())){this.closeValueStateMessage()}};U.prototype.getFocusDomRef=function(){return this.oFileUpload};U.prototype.setEnabled=function(e){var t=jQuery(this.oFileUpload);this.setProperty("enabled",e,false);this.oBrowse.setEnabled(e);if(this.getEnabled()){t.removeAttr("disabled")}else{t.attr("disabled","disabled")}return this};U.prototype._updateButtonType=function(){if(!this.oBrowse){return}const e=this.getValueState();let t;switch(e){case T.Error:t="Reject";break;case T.Success:t="Accept";break;case T.Warning:t="Attention";break;case T.None:case T.Information:default:t="Default";break}this.oBrowse.setType(t)};U.prototype.setValueState=function(e){const t=m(this.getDomRef(),document.activeElement);this.setProperty("valueState",e,false);this._updateButtonType();switch(e){case T.Error:case T.Warning:case T.Success:if(t){this.openValueStateMessage()}break;default:if(t){this.closeValueStateMessage()}}return this};U.prototype.setStyle=function(e){this.setProperty("style",e,true);if(e){if(e=="Transparent"){if(this.oBrowse.setLite){this.oBrowse.setLite(true)}else{this.oBrowse.setType("Transparent")}}else{if(this.oBrowse.setType){this.oBrowse.setType(e)}else{if(e=="Emphasized"){e="Emph"}this.oBrowse.setStyle(e)}}}return this};U.prototype.setValue=function(e,t){const i=this.getValue();let s;if(i!=e||this.getSameFilenameAllowed()){const o=this.getUploadOnChange()&&e;this.setProperty("value",e,o);if(this.oFileUpload&&!this.getTooltip_AsString()){this.oFileUpload.setAttribute("title",e?e:this._getNoFileChosenText())}const r=this.getDomRef("fu_form");if(this.oFileUpload&&r&&!e){r.reset();this._selectedFileNames=[];jQuery(this.FUDataEl).val(this.getAdditionalData())}if(t){if(window.File){s=this.FUEl.files}if(!this.getSameFilenameAllowed()||e&&i!=e){this.fireChange({id:this.getId(),newValue:e,files:s})}}if(o){this.upload()}this._updateTokenizer()}return this};U.prototype.clear=function(){const e=this.getDomRef("fu_form");if(e){e.reset()}else if(this.oFileUpload){this.oFileUpload.files=(new DataTransfer).files}this._selectedFileNames=[];this._updateTokenizer();return this.setValue("",false,true)};U.prototype.openFilePicker=function(e){if(this.oFileUpload){this.oFileUpload.click();if(e){e.preventDefault();e.stopPropagation&&e.stopPropagation()}}return this};U.prototype.getInputReference=function(){return this.oFileUpload};U.prototype.setAdditionalData=function(e){this.setProperty("additionalData",e,true);var t=this.FUDataEl;if(t){e=this.getAdditionalData()||"";t.value=e}return this};U.prototype.sendFiles=function(e,t){var i=this;var s=true;for(var o=0;o<e.length;o++){if(!e[o].bPosted){s=false;break}}if(s){if(this.getSameFilenameAllowed()&&this.getUploadOnChange()){i.setValue("",true)}return}var r=e[t];var a=r.file.name?r.file.name:"MultipartFile";var l=r.requestHeaders;var n=function(e){var t={lengthComputable:!!e.lengthComputable,loaded:e.loaded,total:e.total};i.fireUploadProgress({lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total,fileName:a,requestHeaders:l})};r.xhr.upload.addEventListener("progress",n);r.xhr.onreadystatechange=function(){var e;var t;var s={};var o;var n;var p;var u;u=r.xhr.readyState;var h=r.xhr.status;if(r.xhr.readyState==4){if(r.xhr.responseXML){e=r.xhr.responseXML.documentElement.textContent}t=r.xhr.response;o=r.xhr.getAllResponseHeaders();if(o){n=o.split("\r\n");for(var f=0;f<n.length;f++){if(n[f]){p=n[f].indexOf(": ");s[n[f].substring(0,p)]=n[f].substring(p+2)}}}i.fireUploadComplete({fileName:a,headers:s,response:e,responseRaw:t,readyStateXHR:u,status:h,requestHeaders:l})}i._bUploading=false};if(r.xhr.readyState===0||r.bPosted){t++;i.sendFiles(e,t)}else{r.xhr.send(r.file);r.bPosted=true;t++;i.sendFiles(e,t)}};U.prototype.upload=function(e){var t,i;if(!this.getEnabled()){return}t=this.getDomRef("fu_form");try{this._bUploading=true;if(this.getSendXHR()&&window.File){var s=this.FUEl.files;if(e){this._sendProcessedFilesWithXHR(s)}else{this._sendFilesWithXHR(s)}}else if(t){i=t.getAttribute("action");if(i!==this.getUploadUrl()){this._submitAfterRendering=true}else{this._submitAndResetValue()}}}catch(e){F.error("File upload failed:\n"+e.message)}};U.prototype._submitAndResetValue=function(){var e=this.getDomRef("fu_form");e.submit();this.fireUploadStart();this._resetValueAfterUploadStart()};U.prototype.abort=function(e,t){if(!this.getUseMultipart()){var i=this._aXhr.length-1;for(var s=i;s>-1;s--){if(e&&t){for(var o=0;o<this._aXhr[s].requestHeaders.length;o++){var r=this._aXhr[s].requestHeaders[o].name;var a=this._aXhr[s].requestHeaders[o].value;if(r==e&&a==t){this._aXhr[s].xhr.abort();this.fireUploadAborted({fileName:this._aXhr[s].fileName,requestHeaders:this._aXhr[s].requestHeaders});this._aXhr.splice(s,1);F.info("File upload aborted.");break}}}else{this._aXhr[s].xhr.abort();this.fireUploadAborted({fileName:this._aXhr[s].fileName,requestHeaders:this._aXhr[s].requestHeaders});this._aXhr.splice(s,1);F.info("File upload aborted.")}}}else if(this._uploadXHR&&this._uploadXHR.abort){this._uploadXHR.abort();this.fireUploadAborted({fileName:null,requestHeaders:null});F.info("File upload aborted.")}};U.prototype.onclick=function(e){var t=e.target.getAttribute("type")==="file";if(t&&this.getSameFilenameAllowed()&&this.getEnabled()){this.setValue("",true)}if(e.target.getAttribute("type")==="file"){this.fireBeforeDialogOpen();document.body.onfocus=function(){this.fireAfterDialogClose();document.body.onfocus=null}.bind(this)}};U.prototype._clickHiddenFileInput=function(e){this.openFilePicker(e)};U.prototype._nextToken=function(e){const t=this._getTokenizer();e.preventDefault();if(this._bTokenizerFocus||!t||!t.getTokens().length){return}this._bTokenizerFocus=true;const i=t._getTokenToFocus();if(i&&i.getDomRef()){i.focus()}else{this._bTokenizerFocus=false}};U.prototype._previousToken=function(e){e.preventDefault();if(this._bTokenizerFocus&&e.isMarked("forwardFocusToParent")){this._bTokenizerFocus=false;this.oFileUpload.focus()}};U.prototype.onsapnext=function(e){this._nextToken(e)};U.prototype.onsapprevious=function(e){this._previousToken(e)};U.prototype.onkeydown=function(e){if(!this.getEnabled()){return}if(this.getSameFilenameAllowed()&&this.getUploadOnChange()){this.setValue("",true)}const t=e.keyCode;if(t===_.ENTER&&!this._bTokenizerFocus){this._clickHiddenFileInput(e)}this.oBrowse._bPressedSpace=false};U.prototype.onkeyup=function(e){if(!this.getEnabled()){return}if(this.getSameFilenameAllowed()&&this.getUploadOnChange()){this.setValue("",true)}const t=e.keyCode,i=_;if(!this._bTokenizerFocus&&this.oFileUpload&&(t===_.DELETE||t===_.BACKSPACE)){this._clearSelectedFiles()}else if(t===i.ESCAPE){this.closeValueStateMessage()}else if(!this._bTokenizerFocus&&(t===i.SPACE||t===i.F4||(t===i.ARROW_DOWN||t===i.ARROW_UP)&&e.altKey)){this._clickHiddenFileInput(e)}else if(t!==i.TAB&&t!==i.SHIFT&&t!==i.F6&&t!==i.PAGE_UP&&t!==i.PAGE_DOWN&&t!==i.ESCAPE&&t!==i.END&&t!==i.HOME&&t!==i.ARROW_LEFT&&t!==i.ARROW_UP&&t!==i.ARROW_RIGHT&&t!==i.ARROW_DOWN){e.preventDefault();e.stopPropagation()}this.oBrowse._bPressedSpace=false};U.prototype._isFilenameTooLong=function(e){var t=this.getMaximumFilenameLength();if(t!==0&&e.length>t){F.info("The filename of "+e+" ("+e.length+" characters)  is longer than the maximum of "+t+" characters.");return true}return false};U.prototype.handlechange=function(e){if(this.oFileUpload&&this.getEnabled()){var t=this.getFileType();var i="";var s,o,r,a;var l=this.getDomRef("fu_form");if(window.File){var n=e.target.files;if(this._areFilesAllowed(n)){this.fireFileAllowed();i=this._generateInputValue(n)}else{l.reset();this.setValue("",true,true);return}}else if(t&&t.length>0){s=true;o=this.oFileUpload.value||"";r=o.lastIndexOf(".");a=r===-1?"":o.substring(r+1);for(var p=0;p<t.length;p++){if(a==t[p]){s=false}}if(s){F.info("File: "+o+" is of type "+a+". Allowed types are: "+t+".");this.fireTypeMissmatch({fileName:o,fileType:a});l.reset();this.setValue("",true,true);return}if(this._isFilenameTooLong(o)){this.fireFilenameLengthExceed({fileName:o});l.reset();this.setValue("",true,true);return}if(o){this.fireFileAllowed()}}var u=this.oFileUpload.value||"";var h=u.lastIndexOf("\\");if(h>=0){u=u.substring(h+1)}if(this.getMultiple()||this.getDirectory()){u=i}if(u||g.browser.chrome){this.setValue(u,true)}const f=[];if(window.File){const t=e.target.files;for(let e=0;e<t.length;e++){f.push(t[e].name)}}else{const e=this.oFileUpload.value||"";if(e){f.push(e)}}this._selectedFileNames=f;this._updateTokenizer()}};U.prototype._sendFilesWithXHR=function(e){var t,i,s,o,r=this.getXhrSettings();if(e.length>0){if(this.getUseMultipart()){t=1}else{t=e.length}this._aXhr=this._aXhr||[];for(var a=0;a<t;a++){this._uploadXHR=new window.XMLHttpRequest;o={xhr:this._uploadXHR,requestHeaders:[]};this._aXhr.push(o);o.xhr.open(this.getHttpRequestMethod(),this.getUploadUrl(),true);if(r){o.xhr.withCredentials=r.getWithCredentials()}if(this.getHeaderParameters()){var l=this.getHeaderParameters();for(var n=0;n<l.length;n++){i=l[n].getName();s=l[n].getValue();o.requestHeaders.push({name:i,value:s})}}var p=e[a].name;var u=o.requestHeaders;o.fileName=p;o.file=e[a];this.fireUploadStart({fileName:p,requestHeaders:u});for(var h=0;h<u.length;h++){if(o.xhr.readyState===0){break}i=u[h].name;s=u[h].value;o.xhr.setRequestHeader(i,s)}}if(this.getUseMultipart()){var f=new window.FormData;var d=this.FUEl.name;for(var c=0;c<e.length;c++){this._appendFileToFormData(f,d,e[c])}f.append("_charset_","UTF-8");var g=this.FUDataEl.name;if(this.getAdditionalData()){var y=this.getAdditionalData();f.append(g,y)}else{f.append(g,"")}if(this.getParameters()){var m=this.getParameters();for(var _=0;_<m.length;_++){var F=m[_].getName();s=m[_].getValue();f.append(F,s)}}o.file=f;this.sendFiles(this._aXhr,0)}else{this.sendFiles(this._aXhr,0)}this._bUploading=false;this._resetValueAfterUploadStart()}return this};U.prototype._appendFileToFormData=function(e,t,i){if(i instanceof window.Blob&&i.name){e.append(t,i,i.name)}else{e.append(t,i)}};U.prototype._sendProcessedFilesWithXHR=function(e){this.getProcessedBlobsFromArray(e).then(function(e){this._sendFilesWithXHR(e)}.bind(this)).catch(function(e){F.error("File upload failed: "+e&&e.message?e.message:"no details available")});return this};U.prototype._areFilesAllowed=function(e){var t,i,s,o,r,a=this.getMaximumFileSize(),l=this.getMimeType(),n=this.getFileType();for(var p=0;p<e.length;p++){t=e[p].name;r=e[p].type||"unknown";var u=e[p].size/1024/1024;if(a&&u>a){F.info("File: "+t+" is of size "+u+" MB which exceeds the file size limit of "+a+" MB.");this.fireFileSizeExceed({fileName:t,fileSize:u});return false}if(u===0){F.info("File: "+t+" is empty!");this.fireFileEmpty({fileName:t})}if(this._isFilenameTooLong(t)){this.fireFilenameLengthExceed({fileName:t});return false}if(l&&l.length>0){var h=true;for(var f=0;f<l.length;f++){if(r==l[f]||l[f]=="*/*"||r.match(l[f])){h=false}}if(h&&r!=="unknown"){F.info("File: "+t+" is of type "+r+". Allowed types are: "+l+".");this.fireTypeMissmatch({fileName:t,mimeType:r});return false}}if(n&&n.length>0){i=true;s=t.lastIndexOf(".");o=s===-1?"":t.substring(s+1);for(var d=0;d<n.length;d++){if(o.toLowerCase()==n[d].toLowerCase()){i=false}}if(i){F.info("File: "+t+" is of type "+o+". Allowed types are: "+n+".");this.fireTypeMissmatch({fileName:t,fileType:o});return false}}}return true};U.prototype._sendFilesFromDragAndDrop=function(e){if(this._areFilesAllowed(e)){this._sendFilesWithXHR(e)}return this};U.prototype._generateInputValue=function(e){var t="";for(var i=0;i<e.length;i++){t=t+'"'+e[i].name+'" '}return t};U.prototype._getEffectiveButtonText=function(){return this.getButtonText()||this.oRb.getText("FILEUPLOADER_BUTTON_TEXT")};U.prototype._getBrowseIconTooltip=function(){if(this._selectedFileNames.length>0){return this.oRb.getText("FILEUPLOADER_VALUE_HELP_TOOLTIP")}else if(this.getMultiple()||this.getDirectory()){return this.oRb.getText("FILEUPLOADER_DEFAULT_MULTIPLE_PLACEHOLDER")}else{return this.oRb.getText("FILEUPLOADER_DEFAULT_PLACEHOLDER")}};U.prototype._getNoFileChosenText=function(){if(!U.prototype._sNoFileChosenText){U.prototype._sNoFileChosenText=this.oRb.getText("FILEUPLOADER_NO_FILE_CHOSEN")}return U.prototype._sNoFileChosenText?U.prototype._sNoFileChosenText:"No file chosen"};U.prototype._hasTokenizer=function(){const e=this._getTokenizer(),t=e?e.getTokens().length:0;return!this.getButtonOnly()&&t>0};U.prototype.getShortenValue=function(){return this.getValue()};U.prototype.prepareFileUploadAndIFrame=function(){this._prepareFileUpload();if(!this.oIFrameRef){var e=document.createElement("iframe");e.style.display="none";e.id=this.getId()+"-frame";c.getDomRef().appendChild(e);e.contentWindow.name=this.getId()+"-frame";this._bUploading=false;jQuery(e).on("load",function(e){if(this._bUploading){F.info("File uploaded to "+this.getUploadUrl());var t;try{t=this.oIFrameRef.contentWindow.document.body.innerHTML}catch(e){}this.fireUploadComplete({response:t});this._bUploading=false}}.bind(this));this.oIFrameRef=e}};U.prototype._getCombinedLabelIds=function(){const e=this.getAriaLabelledBy()||[],t=r.getReferencingLabels(this),i=e.slice();t.forEach(e=>{if(i.indexOf(e)===-1){i.push(e)}});return i};U.prototype._getAriaDescribedByIds=function(){const e=this.getValueState(),t=this.getEnabled(),i=this.getAriaDescribedBy()||[],s=i.slice();s.push(this.getId()+"-AccDescr");if(e!==T.None&&e!==T.Error&&t){const e=this.getValueStateMessageId()+"-sr";if(s.indexOf(e)===-1){s.push(e)}}return s};U.prototype._prepareAccessibilityAttributes=function(){const e=[],t=this.getValueState(),i=this.getEnabled(),s=this._getAriaRoleDescription(),o=this._getCombinedLabelIds(),a=this._getAriaDescribedByIds();if(o.length>0){e.push(`aria-labelledby="${o.join(" ")}" `)}if(a.length>0){e.push(`aria-describedby="${a.join(" ")}" `)}if(t===T.Error&&i){e.push('aria-invalid="true" ');const t=this.getValueStateMessageId()+"-sr";e.push(`aria-errormessage="${t}" `)}if(this.getRequired()||r.isRequired(this)){e.push("required ");e.push('aria-required="true" ')}if(s){e.push(`aria-roledescription="${b(s)}" `)}e.push('aria-haspopup="dialog" ');return e};U.prototype._prepareFileUpload=function(){if(!this.oFileUpload){const t=[],i=this._prepareAccessibilityAttributes();t.push("<input ");t.push('type="file" ');if(this.getName()){if(this.getMultiple()||this.getDirectory()){t.push('name="'+b(this.getName())+'[]" ')}else{t.push('name="'+b(this.getName())+'" ')}}else{if(this.getMultiple()||this.getDirectory()){t.push('name="'+this.getId()+'[]" ')}else{t.push('name="'+this.getId()+'" ')}}t.push('id="'+this.getId()+'-fu" ');t.push('tabindex="0" ');t.push('size="1" ');if(this.getTooltip_AsString()){t.push('title="'+b(this.getTooltip_AsString())+'" ')}else{t.push('title="'+b(this.getValue()?this.getValue():this._getNoFileChosenText())+'" ')}if(!this.getEnabled()){t.push('disabled="disabled" ')}if(this.getDirectory()){t.push("webkitdirectory ")}if(this.getMultiple()){t.push("multiple ")}if((this.getMimeType()||this.getFileType())&&window.File){var e=this._getAcceptedTypes();t.push('accept="'+b(e)+'" ')}t.push(...i);t.push(">");this.oFileUpload=jQuery(t.join("")).prependTo(this.$().find(".sapUiFupInputMask")).get(0)}else{jQuery(this.oFileUpload).prependTo(this.$().find(".sapUiFupInputMask"))}if(this._bFocusFileUploader){if(this.getButtonOnly()){this.oBrowse.focus()}else{this.oFileUpload.focus()}this._bFocusFileUploader=false}};U.prototype.openValueStateMessage=function(){if(this._oValueStateMessage&&this.shouldValueStateMessageBeOpened()){this._oValueStateMessage.open()}};U.prototype.closeValueStateMessage=function(){if(this._oValueStateMessage){this._oValueStateMessage.close()}};U.prototype.shouldValueStateMessageBeOpened=function(){return this.getValueState()!=="None"};U.prototype.getValueStateMessageId=function(){return this.getId()+"-message"};U.prototype.getDomRefForValueStateMessage=function(){return this.getButtonOnly()?this.getDomRef().querySelector(".sapMBtnInner"):this.getDomRef()};U.prototype._getAcceptedTypes=function(){var e=this.getMimeType()||[],t=this.getFileType()||[];t=t.map(function(e){return e.indexOf(".")===0?e:"."+e});return t.concat(e).join(",")};U.prototype._resetValueAfterUploadStart=function(){F.info("File uploading to "+this.getUploadUrl());if(this.getSameFilenameAllowed()&&this.getUploadOnChange()&&this.getUseMultipart()){this.setValue("",true)}};U.prototype._getAriaRoleDescription=function(){return this.oRb.getText("FILEUPLOADER_ROLE_DESCRIPTION")};U.prototype._getTitleAttribute=function(){return this.oRb.getText("FILEUPLOADER_INPUT_TOOLTIP")};U.prototype._getEffectivePlaceholder=function(){return this.getPlaceholder()||this._getBrowseIconTooltip()};U.prototype._getValueStateMessageText=function(){const e=this.getValueStateText(),t=this.getValueState(),i=t!==T.Error?`${this.oRb.getText("FILEUPLOADER_VALUE_STATE_"+t.toUpperCase())} `:"";if(e){return`${i}${e}`}if(this._oValueStateMessage&&this._oValueStateMessage._getValueStateText){return`${i}${this._oValueStateMessage._getValueStateText(this,this.getValueState())}`}return""};U.prototype._addLabelFeaturesToBrowse=function(){let e;const t=e=>{e.preventDefault();e.stopPropagation();this.FUEl.click()};if(this.getButtonOnly()&&this.oBrowse&&this.oBrowse.$().length){e=this.oBrowse.$();if(this.oBrowse.getAriaLabelledBy()){r.getReferencingLabels(this).forEach(function(e){const i=o.getElementById(e).$();i.off("click").on("click",t)},this)}e.off("click").on("click",t)}else{e=this.$()}e.off("dragover.fileuploader dragenter.fileuploader drop.fileuploader").on("dragover.fileuploader",e=>{e.preventDefault();e.stopPropagation()}).on("dragenter.fileuploader",e=>{e.preventDefault();e.stopPropagation()}).on("drop.fileuploader",e=>{e.preventDefault();e.stopPropagation();var t=e.originalEvent.dataTransfer.files;if(!this.getMultiple()&&t.length>1||this.getDirectory()){return}this.oFileUpload.files=t;var i={target:{files:t}};this.handlechange(i)})};U.prototype.getProcessedBlobsFromArray=function(e){return new Promise(function(t){t(e)})};U.prototype.checkFileReadable=function(){return new Promise(function(e,t){var i;if(window.File&&this.FUEl&&this.FUEl.files.length){i=new FileReader;i.readAsArrayBuffer(this.FUEl.files[0].slice(0,1));i.onload=function(){e()};i.onerror=function(){t(i.error)}}else{e()}}.bind(this))};return U});
//# sourceMappingURL=FileUploader.js.map